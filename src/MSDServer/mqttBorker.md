# CRUX 서버 메시지 브로커 아키텍처

## 1. 개요  

CRUX 서버는 **PLC 생산라인과 AI 비전 품질검사 라인의 엣지 클라이언트(Edge Clients) 간의 실시간 데이터 통신을 지원** 하기 위해  
**메시지 브로커(Message Broker) 서버를 구축**하였습니다.  

이를 통해 **엣지 클라이언트 간 실시간 데이터를 안정적으로 송수신** 할 수 있으며,  
**생산라인과 품질라인의 데이터를 하나의 통합된 프로토콜로 관리** 할 수 있습니다.  

---

## 2. 메시지 브로커 구조  

![MQTT 메시지 브로커](MQTT_Broker.png)  

### 🔹 **메시지 브로커의 역할**
- **발행(Publish)** → 엣지 클라이언트에서 데이터를 수집하여 메시지 브로커로 전송  
- **구독(Subscribe)** → 생산/품질 모니터링 클라이언트가 실시간 현황을 구독  
- **데이터 중계** → **RabbitMQ(MQTT 프로토콜)** 을 사용하여 데이터 전송을 최적화  

MQTT(Message Queuing Telemetry Transport) 프로토콜을 기반으로 **경량화된 메시지 송수신**을 수행하며,  
이를 통해 **저지연(Low Latency) 통신과 안정적인 데이터 처리**가 가능합니다.  

---

## 3. 메시지 데이터 구조  

MEScadas에서는 **생산라인과 품질라인의 메시지를 아래와 같은 구조로 처리**합니다.  

### 🔹 **생산 메시지 프로토콜**
| 필드명 | 설명 |
|--------|----------------|
| **Topic** | 메시지 주제(Production) |
| **QoS** | 품질 보장 수준 |
| **RetainFlag** | 메시지 지속 여부 |
| **Payload** | 데이터 페이로드 |
| **LineId** | 생산 라인 ID |
| **LotId** | LOT 번호 |
| **Shift** | 근무 교대조 정보 |
| **EmployeeNumber** | 작업자 번호 |
| **StageVal** | 현재 공정 상태 |

---

### 🔹 **품질 메시지 프로토콜**
| 필드명 | 설명 |
|--------|----------------|
| **Topic** | 메시지 주제(Quality) |
| **QoS** | 품질 보장 수준 |
| **RetainFlag** | 메시지 지속 여부 |
| **Payload** | 데이터 페이로드 |
| **LineId** | 검사 라인 ID |
| **LotId** | LOT 번호 |
| **Shift** | 근무 교대조 정보 |
| **EmployeeNumber** | 검사 작업자 번호 |
| **NGImg** | 불량 검출 이미지 |
| **StageVal** | 검사 공정 상태 |

---

## 4. 메시지 브로커의 기대 효과  

| 기존 방식 문제점 | 메시지 브로커 적용 후 개선점 |
|------------------|--------------------------------|
| HTTP 기반 REST API로 인한 데이터 전송 지연 | **MQTT 메시지 브로커 사용으로 저지연 통신 구현** |
| PLC 및 비전 검사 데이터의 통합 부족 | **RabbitMQ를 활용한 중앙 메시지 허브 구축** |
| 대량의 실시간 데이터 처리 시 성능 저하 | **비동기 메시지 처리 방식으로 성능 최적화** |
| 생산라인과 품질라인 간의 데이터 흐름 불일치 | **표준화된 메시지 프로토콜 적용으로 데이터 일관성 확보** |

## 5. 결론  

✅ **MQTT 메시지 브로커(RabbitMQ)를 활용한 실시간 데이터 송수신**  
✅ **생산 및 품질 데이터의 중앙 집중화 및 표준화된 메시지 구조 설계**  
✅ **저지연 통신을 통한 공정 상태 및 품질 데이터 실시간 공유**  
✅ **RabbitMQ 기반의 비동기 메시지 처리로 확장성과 성능 최적화**  

CRUX 서버의 메시지 브로커 아키텍처는 **실시간 생산 관리 및 품질 검사 데이터의 안정적인 송수신을 지원**하며,  
공장 자동화 시스템의 핵심 통신 인프라로 활용될 수 있도록 설계되었습니다. 🚀